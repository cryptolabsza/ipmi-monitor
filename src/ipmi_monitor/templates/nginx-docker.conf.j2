# IPMI Monitor - Nginx Reverse Proxy Configuration
# Generated by: ipmi-monitor quickstart
# Central reverse proxy for all CryptoLabs services

# HTTP server - ACME challenge and redirect to HTTPS
server {
    listen 80;
    server_name {{ domain | default('_') }};
    
    # Let's Encrypt ACME challenge (always enabled for future cert renewal)
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
    
    # Redirect all other traffic to HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

# HTTPS server - main reverse proxy
server {
    listen 443 ssl;
    http2 on;
    server_name {{ domain | default('_') }};
    
{% if letsencrypt_domain %}
    # Let's Encrypt certificates
    ssl_certificate /etc/letsencrypt/live/{{ domain }}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/{{ domain }}/privkey.pem;
{% else %}
    # Self-signed certificates (replace with Let's Encrypt later)
    ssl_certificate /etc/nginx/ssl/server.crt;
    ssl_certificate_key /etc/nginx/ssl/server.key;
{% endif %}
    
    # SSL configuration
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;
    
    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Strict-Transport-Security "max-age=31536000" always;
    
    # ==========================================================================
    # IPMI Monitor at /ipmi/
    # ==========================================================================
    location /ipmi/ {
        proxy_pass http://ipmi-monitor:5000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Script-Name /ipmi;
        
        # WebSocket support for SSE
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Timeouts for long-running requests
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }
    
    # ==========================================================================
    # DC Overview at /overview/ (when installed)
    # ==========================================================================
    # location /overview/ {
    #     proxy_pass http://dc-overview:5001/;
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_set_header X-Forwarded-Proto $scheme;
    #     proxy_set_header X-Script-Name /overview;
    # }
    
    # ==========================================================================
    # Future services - uncomment when added to docker-compose
    # ==========================================================================
    
    # Prometheus at /prometheus/
    # location /prometheus/ {
    #     proxy_pass http://prometheus:9090/;
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_set_header X-Forwarded-Proto $scheme;
    # }
    
    # ==========================================================================
    # Root - Fleet Management Landing Page
    # ==========================================================================
    location = / {
        default_type text/html;
        return 200 '<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ domain | default("Fleet Management") }} - CryptoLabs</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%2300d4ff%22 rx=%2215%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2265%22 font-size=%2250%22 text-anchor=%22middle%22 fill=%22%23fff%22>üñ•</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #e4e4e4;
        }
        .container { text-align: center; padding: 2rem; max-width: 900px; }
        h1 { font-size: 2.5rem; margin-bottom: 0.5rem; color: #00d4ff; }
        .subtitle { color: #888; margin-bottom: 3rem; }
        .services { display: flex; gap: 2rem; flex-wrap: wrap; justify-content: center; }
        .service {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 2rem;
            width: 320px;
            text-decoration: none;
            color: inherit;
            transition: all 0.3s ease;
            position: relative;
        }
        .service:hover {
            background: rgba(0,212,255,0.1);
            border-color: #00d4ff;
            transform: translateY(-5px);
        }
        .service h2 { color: #00d4ff; margin-bottom: 0.5rem; font-size: 1.5rem; }
        .service p { color: #888; font-size: 0.9rem; line-height: 1.5; }
        .service .icon { font-size: 3rem; margin-bottom: 1rem; }
        .service .tag {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: #00d4ff;
            color: #1a1a2e;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        .service .tag.free { background: #10b981; }
        footer { margin-top: 3rem; color: #555; font-size: 0.8rem; }
        code { background: rgba(0,212,255,0.2); padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.85rem; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üñ•Ô∏è Fleet Management</h1>
        <p class="subtitle">{{ domain | default("Data Center Services") }}</p>
        <div class="services">
            <a href="/ipmi/" class="service">
                <div class="icon"><img src="/ipmi/static/favicon.png" alt="IPMI" style="width:48px;height:48px;" onerror="this.outerHTML=&apos;üìä&apos;"></div>
                <h2>IPMI Monitor</h2>
                <p>Server health monitoring, IPMI events, temperature tracking, and AI-powered insights for your data center</p>
            </a>
            <a href="https://www.cryptolabs.co.za/dc-overview/" class="service" target="_blank">
                <span class="tag free">Free</span>
                <div class="icon">üó∫Ô∏è</div>
                <h2>DC Overview</h2>
                <p>Visual data center mapping with rack layouts and infrastructure topology. Easy to install: <code>pip install dc-overview</code></p>
            </a>
        </div>
        <footer>Powered by CryptoLabs Infrastructure</footer>
    </div>
</body>
</html>';
    }
    
    # Health check endpoint
    location = /health {
        return 200 'OK';
        add_header Content-Type text/plain;
    }
}
