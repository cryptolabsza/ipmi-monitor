version: '3.8'

# =============================================================================
# IPMI Monitor - Docker Compose Configuration
# =============================================================================
#
# Quick Start:
#   1. Copy servers.yaml.example to servers.yaml and add your servers
#   2. Set your passwords below
#   3. Run: docker-compose up -d
#
# For more options, see README.md

services:
  ipmi-monitor:
    image: ghcr.io/cryptolabsza/ipmi-monitor:latest
    # Or build locally:
    # build: .
    container_name: ipmi-monitor
    restart: unless-stopped
    ports:
      - "5000:5000"
    environment:
      # ========================================
      # APPLICATION SETTINGS
      # ========================================
      - APP_NAME=IPMI Monitor          # Customize for your organization
      
      # ========================================
      # DEFAULT IPMI CREDENTIALS
      # Used for servers without custom creds
      # ========================================
      - IPMI_USER=admin
      - IPMI_PASS=${IPMI_PASS}         # REQUIRED: Set in .env or export
      - IPMI_PASS_NVIDIA=${IPMI_PASS_NVIDIA}  # For NVIDIA DGX/HGX (16 chars)
      
      # ========================================
      # ADMIN AUTHENTICATION
      # ========================================
      - ADMIN_USER=admin
      - ADMIN_PASS=${ADMIN_PASS:-changeme}    # CHANGE THIS!
      - SECRET_KEY=${SECRET_KEY}              # For session encryption
      
      # ========================================
      # COLLECTION SETTINGS
      # ========================================
      - POLL_INTERVAL=300              # Seconds between collections (5 min)
      - SENSOR_POLL_MULTIPLIER=1       # Collect sensors every N cycles
      
      # ========================================
      # AI FEATURES (Optional)
      # ========================================
      - AI_SERVICE_URL=https://ipmi-ai.cryptolabs.co.za
      # API key is configured via web UI or setup wizard
      
    volumes:
      # Database storage (persistent)
      - ipmi_data:/app/data
      
      # Server configuration file (optional - auto-loads on startup)
      # Create servers.yaml from servers.yaml.example
      - ./config/servers.yaml:/app/config/servers.yaml:ro
      
      # Alternative: Mount entire config directory
      # - ./config:/app/config:ro
      
    networks:
      - monitoring
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  ipmi_data:

networks:
  monitoring:
    driver: bridge

# =============================================================================
# ALTERNATIVE CONFIGURATIONS
# =============================================================================

# --- Option A: Host Network Mode ---
# Use this if BMC IPs are not accessible from Docker bridge network
#
#   ipmi-monitor:
#     network_mode: host
#     ports: []  # Not needed with host network

# --- Option B: Pre-configured Servers via Environment ---
# Instead of servers.yaml, you can set servers via environment:
#
#   environment:
#     - SERVERS_CONFIG_FILE=/app/config/servers.json

# --- Option C: Production with HTTPS ---
# Put behind a reverse proxy (nginx, caddy) for HTTPS:
#
#   ports:
#     - "127.0.0.1:5000:5000"  # Only listen on localhost
#   environment:
#     - SESSION_COOKIE_SECURE=true
